---
title: "Reserves and trade jointly determine exposure to food supply shocks"
output:
  pdf_document:
    fig_caption: yes
bibliography: ref.bib
csl: institute-of-physics-harvard.csl
---

```{r load_packages_funcs, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(maptools)
library(igraph)
library(knitr)
library(stringr)
library(xtable)
library(cowplot)
library(FAOSTAT)
source("cereals-network-funcs.R")
```

```{r global_options, include=FALSE}
options(digits = 3, xtable.comment = FALSE)
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

Philippe Marchand$^1$, Joel A. Carr$^2$, Jampel Dell'Angelo$^1$, Marianela Fader$^3$, Jessica A. Gephart$^2$, Matti Kummu$^4$, Nicholas R. Magliocca$^1$, Miina Porkka$^4$, Michael J. Puma$^5$, Zak Ratajczak$^2$, Maria Cristina Rulli$^6$, David A. Seekell$^7$, Samir Suweis$^8$, Alessandro Tavoni$^9$, Paolo D'Odorico$^{1,2}$

$^1$ National Socio-Environmental Synthesis Center (SESYNC), Annapolis, MD 21401, USA

$^2$ Department of Environmental Sciences, University of Virginia, Charlottesville, VA 22904, USA

$^3$Institut Méditerranéen de Biodiversité et d’Ecologie Marine et Continentale (IMBE), F-13545 Aix-en-Provence cedex 04, France

$^4$Water and Development Research Group (WDRG), Aalto University, FI-00076 Aalto, Finland

$^5$Columbia University Center for Climate Systems Research, NASA Goddard Institute for Space Studies, New York, NY 10025, USA

$^6$Department of Hydraulics, Roadways, Environmental and Surveying Engineering, Politecnico di Milano, Milan I-20133, Italy

$^7$Department of Ecology and Environmental Science, Umeå University, SE-901 87 Umeå, Sweden

$^8$Department of Physics and Astronomy, University of Padova, 35131 Padova, Italy

$^9$Grantham Research Institute on Climate Change and the Environment, London School of Economics, London WC2A 2AE, UK

\newpage

# Abstract

While a growing proportion of global food consumption is obtained through international trade, there is an ongoing debate on whether this increased reliance on trade benefits or hinders food security, and specifically, the ability of global food systems to absorb shocks due to local or regional losses of production. This paper introduces a model that simulates the short-term response to a food supply shock, which is partly absorbed through domestic reserves and consumption, and partly transmitted through the adjustment of trade flows. By applying the model to publicly-available data for the cereals commodity group over a 17-year period, we find that differential outcomes of supply shocks over time are driven not only by the intensification of trade, but as importantly by changes in the distribution of reserves. Our analysis also identifies countries where trade dependency creates a substantial risk of food shortages following a shock; such risk could be reduced by increasing domestic reserves or importing food from a diversity of suppliers that possess their own reserves. This simulation-based model provides a framework to study the short-term, non-linear and out-of-equilibrium response of trade networks to supply shocks, and could be applied to specific scenarios of environmental or economic perturbations.

\newpage

# Introduction

Country-scale food availability depends on domestic production, reserves, and trade. About 24% of the food that is consumed worldwide is available through international trade [e.g., @dodorico2014]; likewise, 24% of the global agricultural land [@weinzettel2013] and 23% of the freshwater resources used for food production [@dodorico2013] are accessed through trade. Trade dependency has substantially increased in the last few decades and more than doubled since the mid-1980s [@porkka2013; @dodorico2014] likely as a result of liberalization and the associated removal of subsidies and trade protections in developing countries [e.g., @shafaeddin2005]. While international food trade increases the variety of food products available to customers and helps buffer the impact of local supply shocks (e.g., crop failures), the effect of recent neoliberal reforms on trade, economic development and food security in the developing world is the subject of a vigorous debate [@schanbacher2010; @oliveira2016]. It has been argued that it may allow for an influx of cheap subsidized food commodities from more developed countries, thereby displacing smallholder farmers, undermining rural livelihoods, and enhancing trade dependency in the global south [@shafaeddin2005; @deschutter2014; @godar2015], as some countries increasingly rely on resources they do not control [e.g., @carr2013; @suweis2013].

Recent studies have stressed the environmental implications of food trade in terms of loss of environmental stewardship resulting from the tele-coupling between agricultural production and consumer behavior or market volatility [@defries2010; @schmitz2012; @meyfroidt2013]. Other studies hint at the emergence of patterns of ecological unequal exchange, whereby an unbalanced distribution and flow of resources and environmental impacts perpetuates conditions of uneven economic development around the world [e.g., @rice2007; @martinez2014]. In particular, the globalization of food through trade has been associated with the exportation and externalization of environmental impacts [@galloway2007; @obannon2014], virtual water and land trade [@hoekstra2008; @fader2011], and the overall geographic disconnection between consumers and the environment that supports them [@carr2013; @macdonald2015].

In contrast with the number of studies on the economic and environmental impacts of food trade, the joint effects of economic and environmental changes on the resilience of the global food system, i.e., its capacity to meet food demand in spite of supply shocks, remain poorly understood [@dodorico2010; @prakash2011; @fader2013; @suweis2015]. In conditions of food crisis, prices dramatically increase, leaving the poor with no or limited access to food [e.g., @deschutter2014]. Moreover, during the recent food crises (e.g., in 2008 and 2011) the governments of exporting countries have responded to food price spikes by banning food exports, thereby leaving trade dependent countries in a state of insecurity [e.g., @fader2013; @puma2015]. Export bans increase the uncertainty and unreliability of the global food markets, thereby eroding food security in trade-dependent countries. 

The impact of the intensification of trade on food security is difficult to evaluate, particularly the short term response of food systems to shocks in production and the way such a response propagates through the global trade network. These effects are hardly captured by state-of the art economic models accounting for changes in supply and price fluctuations. In fact, such models typically assume (general or partial) equilibrium and market-clearing conditions [e.g., @hatfield2013] that are unlikely attained in the course of a food crisis when hoarding and speculations occur while consumers scramble and suppliers make short-term arrangements [@piesse2009; @headey2011; @jones2015]. A shock to production induces a short-term out-of-equilibrium condition in which shortfalls in food supply are addressed through either local adjustments or trade relationships. From a mass balance point of view, this shock may be partly absorbed at the country level by tapping on reserves or reducing domestic consumption, and partly transmitted to other countries as affected regions decrease their exports or increase their imports. The outcome of these processes cannot be predicted through a linear stability/reactivity analysis [e.g., @suweis2015], as large perturbations cause non-linear responses (such as threshold effects) and the system may not recover to its original state.

In this study, we develop a model that simulates the propagation of a food supply shock through the processes described above (changes in reserves, trade and consumption) while preserving mass balance at the country level. We share this approach with other "cascading shock" models applied to specific food commodities [@puma2015; @gephart2016], virtual water [@tamea2016], industrial sectors linked by input-output relationships [@contreras2014] and aggregate economic production [@lee2011]. Our model differs from previous work by its inclusion of food reserves, which empirical research has shown may play a major role in the resilience of food systems [@fraser2015].

We apply our model to a major food commodity group (cereals) using publicly-available data on production, trade and reserves over the last two decades. We make parsimonious assumptions about country-level response to shocks that are consistent with the historical record, and simulate the propagation of shocks under different versions of the trade network to assess: (1) how food reserves and trade patterns interact to increase or decrease exposure to supply shocks; (2) how systemic changes in the cereals trade network over the last 20 years affect the risk (frequency and severity) of national food shortages following supply shocks; and (3) which countries are exposed to the greatest risk and whether these countries or the sources of this risk changed over time.


# Methods

## Simulation model

The model simulates the impact of a shock to the supply of some food commodity on the global trade network for that commodity. The shock is initiated as a drop in production in one or more countries and propagates through the network over multiple iterations of the simulation loop (Fig. \ref{fig:sim_chart}). 

At each iteration, countries affected by a shock first tap into their reserves. When reserves are depleted, countries absorb a fraction of the residual shock by reducing domestic consumption, then reduce their trade balance by decreasing exports and increasing imports, with the impact spread to each trade link proportionally to the volume on that link.[^1] This propagates the shock from affected countries to their trade partners. Finally, any shock that could not be propagated is absorbed by reducing domestic consumption. These steps are repeated until all shocks have been absorbed (see the supplementary materials for a detailed description of the model and Table \ref{tab:var_list} for a list of symbols and variables used in this paper). 

[^1]: The exception to this rule, as illustrated in Fig. \ref{fig:sim_chart}, is that countries cannot import more from a partner country that already reduced its trade balance following a shock, i.e. such trade links are "blocked" from further increases.

To avoid arbitrarily small shocks being propagated, countries will absorb (through consumption) any shock smaller than a fraction $\alpha$ of their current supply; we set $\alpha$ = 0.001% for all our simulations.

```{r tab_var_list, results = "asis"}
var_list <- data.frame(rbind(
    c("$N_c$", "Number of countries in network"),
    c("$P$", "Production by country"),
    c("$R$", "Reserves by country"),
    c("$F$", "Trade matrix ($F_{jk}$ = exports from country $j$ to country $k$)"),
    c("$E$", "Exports by country i.e. $\\sum_k F_{jk}$"),
    c("$I$", "Imports by country i.e. $\\sum_k F_{kj}$"),
    c("$C$", "Domestic consumption by country (for any use)"),
    c("$S$", "Net supply, $S = P + I - E$"),
    c("$\\alpha$", "Minimum threshold (as fraction of $S$) for a shock to be propagated"),
    c("$f_c$", "Fraction of residual shock absorbed by $C$ if $R$ is depleted"),
    c("$f_r$", "Fraction of actual reserves that are available to absorb shocks"),
    c("$f_p$", "Magnitude of initial shock as a fraction of the affected country's $P$")
))
colnames(var_list) <- c("Symbol", "Description")

print(xtable(var_list, label = "tab:var_list", 
             caption = paste("List of variables and parameters", 
                             "of the shock propagation model\\newline")), 
      caption.placement = "top", include.rownames = FALSE, 
      sanitize.text.function = function(x) {x})
```

![Simulation model flow chart. See Table \ref{tab:var_list} for a list of variables.\label{fig:sim_chart}](model-flow-chart.pdf)

The assumption that production shocks are absorbed first by reserves is supported by the FAO commodity balance data, showing that interannual changes in cereals production ($\Delta P$) are most closely associated with changes in $R$. In contrast, all components of $C$, except animal feed, show little interannual variation and little to no association with $\Delta P$ (see Supplementary Table 2). Both $E$ and $I$ are more variable than $C$ over time, but these changes are mostly uncorrelated with $\Delta P$, as trade dynamics are affected by other factors than immediate changes in production. We further discuss these assumptions and alternatives at the end of the paper.

## Data

We initialize our model with historical data on the international trade in cereals. As a major component of global food trade and food stocks, cereals provide a natural starting point to study how food security is impacted by the distribution of trade flows and reserves. By focusing our analysis on a commodity group rather than a single commodity, we avoid the need to consider substitution effects between functionally-similar crops in that group.

We use the cereals production and trade data from the Food and Agricultural Organization of the United Nations' online database (FAOSTAT, faostat3.fao.org, data acquired in January 2016). Production and trade quantities for individual primary and secondary commodities in the cereals group are converted into kcal equivalents [@fao2001] and aggregated by country and year (see Supplementary Table 1 for the list of included crops and conversion factors). We use population data from FAOSTAT to subset the network so that only countries with a population exceeding half a million people during the period 1986-2011 are considered. We rectify the data as described in @carr2013 to account for the merging and splitting of countries between years.

We obtain data on countries' cereals reserves from the Production, Supply and Distribution database of the United States Department of Agriculture's Foreign Agricultural Service (USDA-PSD, apps.fas.usda.gov/psdonline/, data acquired in October 2015). Reserves for nine commodities (barley, corn, millet, mixed grain, oats, rice, rye, sorghum and wheat) were converted in kcal equivalents and aggregated by country and year, and political entities were rectified to match the FAO data above. While the USDA-PSD data does not include some minor crops covered by FAOSTAT (including buckwheat, fonio and quinoa), those nine commodities account for over 90% of the total grain production reported by FAOSTAT over the 25-year period. Note that since USDA-PSD reports aggregated reserves for the European Union (pre-1998) and EU-25 (1998 and after), we divide these reserves between EU countries for each year in proportion to their share of the EU cereals production.

```{r load_trade_data, results = "asis"}
years <- c(1996, 2003, 2009)
trade_dat <- lapply(years, get_trade_data, mov_avg = 2,
                    prod_trade_file = "data/cereals_prod_trade.RData", 
                    stocks_file = "data/cereals_stocks.RData")
names(trade_dat) <- years
trade_st <- bind_rows(lapply(trade_dat, get_trade_stats_sum), .id = "year")
    
kable(trade_st,
      col.names = c("med. year", "$N_c$", "$\\sum P$ (kcal)", "$\\sum R$ (kcal)", 
                    "# trade links", "$\\sum F$ (kcal)",  
                    "$\\sum R / \\sum P$", "$\\sum F / \\sum P$"),
      caption = paste("Summary statistics of the cereals trade data",
                      "for each time period considered in our analysis", 
                      "($N_c$ = number of countries in network,",
                      "$P$ = production, $R$ = reserves, $F$ = trade volume)"))
```

For model input, we average the cereals production, reserves and trade over three five-year periods (1994-1998, 2001-2005 and 2007-2011), which we refer to by their median years (1996, 2003 and 2009). The averaging process smooths out short-term perturbations in the data, and the set of countries was constant over each period (no merge/split event). The evolution of the cereals trade across these three time periods shows a decrease of global reserves and an increase in global trade, both expressed as a fraction of total production (Table 2).

```{r r_scaling}
Rscale <- trade_st$RP_ratio / trade_st$RP_ratio[trade_st$year == "2009"]
trade_Rscaled <- Map(
    function(dat, scal) {
        dat$R0 <- dat$R0 / scal
        dat
    }, trade_dat, Rscale)

S0 <- lapply(trade_dat, function(x) x$P0 + colSums(x$E0) - rowSums(x$E0))
RSscale <- trade_dat$`2009`$R0 / S0$`2009`
trade_RSscaled <- Map(
    function(dat, s0) {
        dat$R0 <- RSscale[names(s0)] * s0
        dat
    }, trade_dat, S0)
```

\newpage

To separate the effects of changes in reserves and trade flows on model outcomes, we perform two different scalings of the 1996 and 2003 reserves: (1) in the $R$-scaled version, all countries' reserves are scaled by a common factor so that the ratio of global $R$ to global $P$ matches that of 2009 (e.g., from the table above, the global $R/P$ ratio is 0.262 in 1996 and 0.192 in 2009, so the 1996 $R$-scaling would multiply each country's reserves by 0.192/0.262); (2) in the $R/S$-scaled version, each country's reserves are adjusted so that the ratio of $R$ to the net supply $S$ matches that of 2009 for that country (e.g., the $R/S$ ratio for Australia in 2009 is 0.435, so its actual 1996 reserves would be replaced with 0.435 times its 1996 supply). Comparison between simulations based on the original data and results from these scaled versions allow us to identify the impact of (1) changes in global reserves or (2) changes in the distribution of these reserves among countries, respectively. 


## Simulation parameters and response variables

In this study, we refer to a model run as a set of $N_c$ simulations, to observe the effect of a production shock initiated (separately) at each country in the dataset. For each run, we select one of the three time periods, a specific scaling of the reserves (see above) and three global parameters: the initial shock magnitude as a fraction of the target country's production ($f_p$), the fraction of reserves that are available to absorb a shock ($f_r$), as well as the fraction of a shock absorbed by consumption after reserves are depleted ($f_c$, as defined in our model above). In practice, setting $f_r < 1$ may reflect the fact that some of the reported reserves are already committed to trade or that countries are unwilling to let reserves drop below some floor amount. 

```{r run_sims}
get_multiyear_sim_results <- function(trade_data, pfrac, rfrac, cfrac) {
    res <- lapply(trade_data, 
                  function(x) sim_allc(pfrac, x$P0, rfrac*x$R0, x$E0, cfrac))
    st <- lapply(res, get_stats_allc)
    trade_stats <- bind_rows(lapply(trade_data, get_trade_stats_by_cty),
                             .id = "year") 
    sim_stats <- bind_rows(lapply(st, get_sim_stats_by_cty))
    cbind(fp = pfrac, fr = rfrac, fc = cfrac, trade_stats, sim_stats)
}

# stats_by_cty <- bind_rows(
#    "02_05"    = get_multiyear_sim_results(trade_dat, 0.2, 0.5, 0.01),
#    "Rscaled"  = get_multiyear_sim_results(trade_Rscaled, 0.2, 0.5, 0.01),
#    "RSscaled" = get_multiyear_sim_results(trade_RSscaled, 0.2, 0.5, 0.01),
#    "01_025"   = get_multiyear_sim_results(trade_dat, 0.1, 0.25, 0.01),
#     "03_1"     = get_multiyear_sim_results(trade_dat, 0.3, 1, 0.01),
#     "015_05"   = get_multiyear_sim_results(trade_dat, 0.15, 0.5, 0.01),   
#     "02_05_005"= get_multiyear_sim_results(trade_dat, 0.2, 0.5, 0.05),
#     "02_05_01" = get_multiyear_sim_results(trade_dat, 0.2, 0.5, 0.1),    
#     .id = "params")
# 
# stats_by_cty <- mutate(stats_by_cty, tot_dS_scl = tot_dS_S0 / fp, 
#                     tot_dC_scl = tot_dC_S0 / fp, self_dC_scl = self_dC_S0 / fp)

# Params groups
Rscal <- c("02_05", "Rscaled", "RSscaled")
Cfrac <- c("02_05", "02_05_005", "02_05_01")
PR <- c("01_025", "015_05", "02_05", "03_1")

# saveRDS(stats_by_cty, "stats_by_cty.RData")
stats_by_cty <- readRDS("stats_by_cty.RData")

```

For each model run, we report the number of simulations where the initial shock was transmitted ($N_s$), i.e. excluding those where the target country has no production or has available reserves that exceed the loss of production. We calculate the following summary metrics for each country: the number of *hits*, or simulations where the country receives a shock ($N_{h}$); the number of hits where domestic consumption is affected ($N_{hc}$); the relative change in net supply ($\Delta s_{rel}$) and consumption ($\Delta c_{rel}$) over all simulations; and the evenness ($J$) of impact across simulations (see below).

To compare the average impact of a shock across countries and model runs, the total changes in supply ($\Delta S_j$) and consumption ($\Delta C_j$) for a given country $j$ are scaled by its initial supply ($S_{0,j}$) and the simulation parameter $f_p$, i.e. if $\Delta S^{(k)}_j$ is the impact on $S_j$ of a shock initiated at country $k$, then:    
\begin{align} \label{eq:dsrel}
    \Delta s_{rel,j} = \frac{\sum_k \Delta S^{(k)}_j}{f_p S_{0,j}} \; \text{and} \; 
    \Delta c_{rel,j} = \frac{\sum_k \Delta C^{(k)}_j}{f_p S_{0,j}} \, ,
\end{align}
where the sum is taken over all simulations (initiated at each country) in a given model run. These metrics are always negative, so we usually refer to their magnitude, e.g. which countries receive a greater shock or impact.

The average of $\Delta s_{rel}$ for all affected countries may be less or greater than -1, depending on the covariance between $\Delta s_{rel}$ and the initial supply $S_0$. Starting from eq. \ref{eq:dsrel}, we obtain ($\mathrm{E}$ denotes the expected value):
\begin{align} 
    \mathrm{E} \left[ \sum_k \Delta S^{(k)} \right] 
        = \mathrm{E} \left[ \Delta s_{rel} \right] \mathrm{E} \left[f_p S_0 \right] 
        + \mathrm{cov} \left( \Delta s_{rel}, f_p S_0 \right) \, ,
\end{align}
\begin{align} \label{eq:dscov}
    \mathrm{E} \left[ \Delta s_{rel} \right] 
        = \frac{\mathrm{E} \left[ \sum_k \Delta S^{(k)} \right]}{f_p \mathrm{E} \left[ S_0 \right]} 
        - \frac{1}{\mathrm{E} \left[ S_0 \right]} \mathrm{cov} \left( \Delta s_{rel}, S_0 \right) \, .
\end{align}
Since the mean supply equals the mean production, both the numerator and the denominator of the first term on the right-hand side are equal in magnitude to the mean initial shock over simulations, and thus:
\begin{align}
    \mathrm{E} \left[ \Delta s_{rel} \right] 
        = -1 - \frac{1}{\mathrm{E} \left[ S_0 \right]} \mathrm{cov} \left( \Delta s_{rel}, S_0 \right) \, .
\end{align}

Based on Pielou's measure of community evenness in ecology [@pielou1966], $J$ measures the degree to which the total impact on a country is spread out across multiple simulations. It is calculated as:
\begin{align} \label{eq:even}
    J_j = - \frac{1}{\log N_c} \sum_k \pi_{kj} \log \pi_{kj} \, ,
\end{align}
where $\pi_{kj}$ is the proportion of the total $\Delta S_j$ that is due to a shock initiated at country $k$:
\begin{align}
    \pi_{kj} = \frac{\Delta S^{(k)}_j}{\sum_l \Delta S^{(l)}_j} \, .
\end{align}
Note that terms with $\pi_{kj} = 0$ are excluded from the sum in eq. (\ref{eq:even}). When the whole impact on country $j$ occurs in a single simulation, $J_j = 0$; if it is due equally to shocks originating from all countries, $J_j = 1$. Since a single shock is spread out across many countries through trade, we expect this metric to increase with the number of links and trade volume in the network.

## Model implementation

We performed the simulations and all data processing steps in R [@r2015], using the FAOSTAT package [@kao2015] to facilitate data acquisition from the FAOSTAT database. The necessary code to reproduce all results in this paper is available on GitHub (http://github.com/pmarchand1/cereals-network-shocks).


# Results

## Global parameters and network-wide effects

Before considering how historical changes in the cereals trade network affect shock propagation, we first examine the effect of the adjustable global parameters on simulation outputs; these results are shown in Table \ref{tab:pars_stat} using the most recent (2009) data version. Between the first two rows, both $f_p$ and $f_r$ are doubled so that the ratio of shock intensity to initial reserves remains constant. This leaves most impact metrics unaffected, except for the mean relative change in consumption ($\Delta c_{rel}$), which nearly doubles. In this scenario, even if countries have larger available reserves, their trade flows remain the same and may limit the amount of residual shock that can be passed along, resulting in a greater impact on consumption. The same effect would explain the decrease in evenness $J$ between the two cases. Predictably, raising $f_c$ (third and fouth rows) monotonically increases the magnitude of $\Delta c_{rel}$ while leaving other statistics unchanged.

```{r tab_pars_stat, results = "asis"}
hits_summ <- stats_by_cty %>%
    filter(params %in% c(Cfrac, PR), year == 2009) %>%
    group_by(params) %>%
    summarise(fp = mean(fp), fr = mean(fr), fc = mean(fc),
              nshocks = sum(self_dC_scl < 0), 
              hits_m = mean(hits), hits_sd = sd(hits),
              mean_tot_dS = mean(tot_dS_scl), sd_tot_dS = sd(tot_dS_scl),
              mean_even = mean(even), sd_even = sd(even),
              hitsC = mean(hitsC), mean_tot_dC = mean(tot_dC_scl)) %>%
    select(-params) %>% arrange(desc(nshocks))

titlerow <- list(pos = list(0, 0),
    command = c(paste("$f_p$ & $f_r$ & $f_c$ & $N_s$ &",
                      "\\multicolumn{2}{c}{$N_{h}$} &", 
                      "\\multicolumn{2}{c}{$\\Delta s_{rel}$} &",
                      "\\multicolumn{2}{c}{$J$} & $N_{hc}$ &",
                      "$\\Delta c_{rel}$ \\\\\n"),
                paste("& & & & mean & s.d. & mean & s.d. &",
                      "mean & s.d. & mean & mean \\\\\n")))
pars_stat <- xtable(hits_summ, label = "tab:pars_stat",
    caption = paste("Effect of global parameters (defined in Table \\ref{tab:var_list})",
                    "on simulation outputs using the 2009 data. $N_s$ is the number",
                    "of simulations where a shock is passed; $N_h$ (resp., $N_{hc}$) is",
                    "the number of times a country's supply (resp., consumption)",
                    "are affected across simulations; $\\Delta s_{rel}$",
                    "(resp., $\\Delta c_{rel}$) is a relative measure of the total",
                    "change in a country's supply (resp., consumption) across simulations",
                    "$J$ is the evenness of impact between simulations. Means and",
                    "standard deviations are calculated across affected countries.",
                    "\\newline"),
    align = "lrrr|rrrrrrrrr")
print(pars_stat, add.to.row = titlerow, caption.placement = "top",
      include.rownames = FALSE, include.colnames = FALSE, 
      hline.after = c(-1, 0, 2, 4, 6))
```

Compared to the first two cases, the last two rows in Table \ref{tab:pars_stat} represent a 50% increase in shock intensity and a doubling of reserves. As more countries can absorb a shock through their reserves, the number of simulations where a shock is passed ($N_s$), as well as the mean number of hits ($N_{h}$ and $N_{hc}$) by country all decrease. Since a larger portion of the shock is absorbed by the initial target, shocks become less spread out and the evenness $J$ decreases.

Based on model runs with a fixed set of global parameters, the most recent trade network (2009) appears to have a greater capacity to absorb shocks compared with those of 1996 and 2003, as evidenced by a decrease in hits by country ($N_{h}$, $N_{hc}$) and a lesser impact on consumption ($\Delta c_{rel}$) (Table \ref{tab:Rscal_stat}). However, this pattern is largely driven by the distribution of reserves rather than increased trade. Despite the total reserves being greater in 1996 and 2003 -- which explains why the impact metrics are even higher when scaling these total reserves to 2009 levels -- they are less evenly distributed, with a few countries (such as China) holding a very large proportion of their net supply in reserve and more countries having no reported reserves. By scaling relative reserves by country to their 2009 values ($R/S$-scaling), we see that the number of hits by country monotonically increases over time, with a small increase in the mean evenness of the impact across simulations, all factors consistent with an increase of the number and volume of trade connections.

```{r tab_Rscal_stat, results = "asis"}
hits_summ_Rscal <- stats_by_cty %>%
    filter(params %in% c(Rscal), year != 2009 | params == "02_05") %>%
    group_by(params, year) %>%
    summarise(nshocks = sum(self_dC_scl < 0), 
              hits_m = mean(hits), hits_sd = sd(hits),
              mean_tot_dS = mean(tot_dS_scl), sd_tot_dS = sd(tot_dS_scl),
              mean_even = mean(even), sd_even = sd(even),
              hitsC = mean(hitsC), mean_tot_dC = mean(tot_dC_scl)) %>%
    ungroup %>% select(-params, -year)

rownames(hits_summ_Rscal) <- c("1996 (original)", "2003 (original)",
                               "2009 (original)", "1996 ($R$-scaled)",
                               "2003 ($R$-scaled)", "1996 ($R/S$-scaled)",
                               "2003 ($R/S$-scaled)")
titlerow <- list(pos = list(0, 0),
    command = c(paste("year (version) & $N_s$ &",
                      "\\multicolumn{2}{c}{$N_{h}$} &", 
                      "\\multicolumn{2}{c}{$\\Delta s_{rel}$} &",
                      "\\multicolumn{2}{c}{$J$} & $N_{hc}$ &",
                      "$\\Delta c_{rel}$ \\\\\n"),
                paste("& & mean & s.d. & mean & s.d. &",
                      "mean & s.d. & & \\\\\n")))
Rscal_stat <- xtable(hits_summ_Rscal, label = "tab:Rscal_stat",
    caption = paste("Summary statistics by input data version with global parameters",
                    "set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01. $N_s$ is the number",
                    "of simulations where a shock is passed; $N_h$ (resp., $N_{hc}$) is",
                    "the number of times a country's supply (resp., consumption)",
                    "are affected across simulations; $\\Delta s_{rel}$",
                    "(resp., $\\Delta c_{rel}$) is a relative measure of the total",
                    "change in a country's supply (resp., consumption) across simulations",
                    "$J$ is the evenness of impact between simulations. Means and",
                    "standard deviations are calculated across affected countries.",
                    "\\newline"),
    align = "l|rrrrrrrrr")
print(Rscal_stat, add.to.row = titlerow, caption.placement = "top",
      include.colnames = FALSE, hline.after = c(-1, 0, 3, 5, 7),
      sanitize.rownames.function = function(x) {x})
```

While a more even distribution of reserves lessens the average impact on domestic consumption, it increases the average relative shock felt by countries ($\Delta s_{rel}$). To understand this pattern, we note that the mean of $\Delta s_{rel}$ is greater than -1 for all our model runs, which, based on eq. \ref{eq:dscov}, means that countries with a larger $S_0$ receive a proportionally greater impact from the shocks. This can be in turn related to the structure of the cereals trade network. A few large producers account for most of the net exports and receive more shocks due to their central position in the network (i.e. as each of their many trade partners will increase their imports when affected by a shock). These main producers/exporters also tend to have proportionately higher reserves, allowing them to absorb most of these shocks (see Supplementary Figure 1). The fact that the mean $\Delta s_{rel}$ approaches -1 in 2009 shows that these discrepancies are becoming less important. Once again, a large portion of the change between 1996 and 2009 can be explained by the distribution of reserves, with the residual differences (shown in the $R/S$-scaled version) reflecting the intensification of trade.

Although the previous tables do not indicate the standard deviations for the consumption impact metrics ($N_{hc}$ and $\Delta c_{rel}$), their distributions are highly skewed with most countries receiving little to no impact. As such, we focus on the most impacted countries in the next section. 

## Country-level impacts

```{r ds_dc_prep}
# Load basemap
data(wrld_simpl)
world_df <- fortify(wrld_simpl)

# ggplot theme for mapping
theme_map <- function(base_size = 12, base_family = "Helvetica") {
    theme_bw(base_size = base_size, base_family = base_family) %+replace%
        theme(rect = element_blank(), line = element_blank(),
              axis.text = element_blank(), axis.title = element_blank())
}

plot_params <- c("02_05_1996", "RSscaled_1996", "02_05_2009")
ds_dc <- stats_by_cty %>% unite(version, params, year, sep = "_") %>%
    filter(version %in% plot_params) %>%
    select(id = cty, version, tot_dS_S0, tot_dC_S0)
ds_dc$version <- factor(ds_dc$version, levels = plot_params,
                        labels = c("1996 (original)", "1996 (R/S-scaled)", "2009"))
world_ds_dc <- inner_join(world_df, ds_dc)
```

```{r ds_map, fig.width = 7, fig.height = 10, fig.cap = "\\label{fig:ds_map}Total change in net supply ($\\sum \\Delta S$, summed over simulated shocks starting from each country) as a fraction of the affected country's initial supply ($S_0$), for three versions of the input data. The middle panel ($R/S$-scaled) uses the 1996 production and trade data, but scales the reserves to match the 2009 reserves/supply ratio. Global simulation parameters (see Table \\ref{tab:var_list}) are set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01."}
ggplot() + geom_polygon(aes(long, lat, group = group, fill = tot_dS_S0),
                                 data = world_ds_dc, colour = "grey", size = 0.25) +
    scale_fill_gradient(low = "red", high = "white", na.value = "grey") +
    labs(fill = expression(sum(Delta * S / S[0]))) +
    facet_wrap(~ version, ncol = 1) + coord_fixed() + theme_map()
```

```{r dc_map, fig.width = 7, fig.height = 10, fig.cap = "\\label{fig:dc_map}Total change in domestic consumption ($\\sum \\Delta C$, summed over simulated shocks starting from each country) as a fraction of the affected country's initial supply ($S_0$), for three versions of the input data. The middle panel ($R/S$-scaled) uses the 1996 production and trade data, but scales the reserves to match the 2009 reserves/supply ratio. Global simulation parameters (see Table \\ref{tab:var_list}) are set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01."}
ggplot() + geom_polygon(aes(long, lat, group = group, fill = tot_dC_S0),
                                 data = world_ds_dc, colour = "grey", size = 0.25) +
    scale_fill_gradient(low = "red", high = "white", na.value = "grey") +
    labs(fill = expression(sum(Delta * C / S[0]))) +
    facet_wrap(~ version, ncol = 1) + coord_fixed() + theme_map()
```

Figures \ref{fig:ds_map} and \ref{fig:dc_map} present the total impact on the supply and consumption (respectively) of each country for three different model runs: original 1996 data, 1996 data scaled with $R/S$ ratios from 2009, and original 2009 data. As stated in the previous section, major exporters tend to absorb a disproportionate share of shocks relative to their base supply (Fig. \ref{fig:ds_map}), due to their large reserves and high number of trade links. However, these large reserves also ensure that the impact on domestic consumption is negligible (Fig. \ref{fig:dc_map}). The larger impact on $\Delta S$ for Argentina, Australia and Paraguay in 2009 (Fig. \ref{fig:ds_map}) reflects the growing relative importance of their exports. Some countries with low production and high trade can also exhibit a high aggregate $\Delta S$, such as Oman, which increased both its reserves and trade volume between 1996 and 2009.

Countries where the simulated shocks produce substantial decreases in domestic consumption are concentrated in a few regions: Central America, the Sahel and East Africa, South and South-East Asia and (in 1996 only) the former Soviet Union (Fig. \ref{fig:dc_map}). Compared with the original 1996 data, simulations using the $R/S$-scaled reserves led to smaller impacts to consumption overall. Changes in the trade network itself greatly reduced the $\Delta C$ impact on many countries, including most of the former Soviet Union, Afghanistan, Sudan and Tanzania, but led to larger impacts in others, notably in Central America. 

```{r dc_prep}
stats_dC <- stats_by_cty %>% 
    filter(params == "02_05" | params == "RSscaled" & year %in% c("1996", "2003"), 
           tot_dC_scl < 0) %>%
    select(-fp, -fr, -fc, -hits, -links_hit, -tot_dS_S0, -even, -tot_dS_scl) %>%
    mutate(ext_dC_scl = tot_dC_scl - self_dC_scl,
           ext_dC_S0 = tot_dC_S0 - self_dC_S0) %>%
    group_by(cty) %>%
    filter(min(tot_dC_S0) < -0.01)

stats_dC_ext <- filter(stats_dC, ext_dC_S0 < -0.01)

# st_02_05 <- lapply(trade_dat, function(x) {
#   get_stats_allc(sim_allc(0.2, x$P0, 0.5*x$R0, x$E0, 0.01))  
# })
# 
# st_RSscaled <- lapply(trade_RSscaled, function(x) {
#   get_stats_allc(sim_allc(0.2, x$P0, 0.5*x$R0, x$E0, 0.01))  
# })


get_dC_tall <- function(st, countries) {
    dC <- st$dC_S0[rownames(st$dC_S0) %in% countries, ]
    cbind(to = rownames(dC), as.data.frame(dC)) %>%
        gather(key = "from", value = "dC_S0", -to)
}

# dC_all <- bind_rows(
#     `02_05` = bind_rows(lapply(st_02_05, get_dC_tall,
#                                 countries = unique(stats_dC$cty)), .id = "year"),
#     RSscaled = bind_rows(lapply(st_RSscaled, get_dC_tall, 
#                                 countries = unique(stats_dC$cty)), .id = "year"),
#     .id = "params"
# )

# saveRDS(dC_all, "dC_all.RData")
dC_all <- readRDS("dC_all.RData")

dCext <- dC_all %>%
    filter(to %in% stats_dC_ext$cty, to != from, year != "2003") %>%
    group_by(to, from) %>% filter(any(dC_S0 < -1E-3))
dCself <- filter(dC_all, to == from, year != "2003") %>% 
    select(params, year, cty = to, dC_S0) %>%
    group_by(cty) %>% filter(any(dC_S0 < -1E-2))
rm(dC_all)

dCself_year <- spread(dCself, key = year, value = dC_S0)

dCplot_self <- ggplot(data = dCself_year, aes(x = `1996`, y = `2009`, 
                               group = cty, color = params)) +
    geom_text(aes(label = cty), alpha = 0.8, size = 3, angle = 45) +
    scale_color_manual(values = c("darkblue", "orange2"), name = "",
                       labels = c("original", "R/S-scaled")) +
    geom_abline() + geom_line(color = "grey", linetype = "dotted") +
    labs(x = expression(paste(Delta * C[internal] / S[0], " in 1996")),
         y = expression(paste(Delta * C[internal] / S[0], " in 2009"))) +
    coord_fixed() +
    theme_cowplot(font_size=10) +
    theme(axis.title.x = element_text(margin = margin(12, 0, 0, 0)), 
          axis.title.y = element_text(margin = margin(0, 12, 0, 0)))

dCext_year <- group_by(dCext, params, year, to) %>%
    summarise(dC_S0 = sum(dC_S0)) %>%
    spread(key = year, value = dC_S0)

dCplot_ext <- ggplot(data = dCext_year, aes(x = `1996`, y = `2009`, 
                              group = to, color = params)) +
    geom_text(aes(label = to), alpha = 0.8, size = 3, angle = 45) +
    scale_color_manual(values = c("darkblue", "orange2"), name = "",
                       labels = c("original", "R/S-scaled")) +
    geom_abline() + geom_line(color = "grey", linetype = "dotted") +
    labs(x = expression(paste(Delta * C[external] / S[0], " in 1996")),
         y = expression(paste(Delta * C[external] / S[0], " in 2009"))) +
    coord_fixed() +
    theme_cowplot(font_size=10) +
    theme(axis.title.x = element_text(margin = margin(12, 0, 0, 0)), 
          axis.title.y = element_text(margin = margin(0, 12, 0, 0)))
```

```{r dc_self_ext, fig.height = 8, fig.cap = "\\label{fig:dc_self_ext}Decrease in consumption ($\\Delta C$) as a fraction of initial net supply ($S_0$) from (a) internal shocks (i.e. shock was initiated at the target country) and (b) external shocks (initiated at other countries), compared between the 1996 and 2009 trade networks. Two outcomes are given in 1996 based on whether the original reserves or those scaled to the 2009 reserves/supply ratio are used. Each plot includes all countries where the decrease exceeded 1% in at least one simulation. Global simulation parameters (see Table \\ref{tab:var_list}) are set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01. Country labels correspond to their ISO alpha-3 codes."}

plot_grid(dCplot_self, dCplot_ext, label_size = 12, labels = c("a", "b"), 
          vjust = 1, ncol = 1, scale = 0.9, align = "h")
```

We can gain additional insights on these results by separating the share of $\Delta C$ in a country due to the shock initiated at that same country (internal shock) and that which is due to shocks initiated at other countries (external shocks). Figure \ref{fig:dc_self_ext}(a) compares the impact on the 40 countries that experience a >1% decrease in consumption due to an internal shock in at least one model run. Using either the original or $R/S$-scaled reserve levels, most countries lie above the 1:1 dividing line and are thus less impacted in the 2009 trade network. This is consistent with the additional trade links and volume, which result in a greater capacity to transfer an internal shock to trade partners. 

Conversely, a majority of the 24 countries receiving a substantial (>1% of $S_0$) external shock are more impacted under the 2009 trade network (Fig. \ref{fig:dc_self_ext}(b)), reflecting an increased reliance on food imports from one or a few trade partners. A look at the specific external shocks causing these $\Delta C$ show that they originate from nine source countries (Fig. \ref{fig:dCext_net}), with 14 of these shocks -- including the four greatest in magnitude -- caused by an initial production drop in the United States. While the other target countries in the graph experience this risk from one or two simulations, the $\Delta C$ in Singapore is spread over five sources; it also has the lowest aggregate $\Delta C$, only slightly above the 1% threshold.

```{r dCext_net, results = "hide"}
#```{r dCext_net, fig.width = 6, fig.height = 6, fig.cap = "\\label{fig:dCext_net}Graph of countries (in blue) having to reduce consumption for a shock initiated at source countries (in orange). The width of each edge is proportional to $\\log \\Delta C / S_0$. Simulations initialized with 2009 input data and global parameters $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01. Country labels correspond to their ISO alpha-3 codes."}
dCext_graph <- graph_from_data_frame(
    filter(dCext, params == "02_05", year == "2009") %>%
    mutate(width = log(-dC_S0) + 7) %>%
    select(from, to, width)
)
V(dCext_graph)$color <- ifelse(degree(dCext_graph, mode = "out") == 0, 
                               "white", "orange")

pdf(file = "fig_dCext_net.pdf", width = 6, height = 6)
plot(dCext_graph, vertex.label.color = "black",
     vertex.size = 15, vertex.label.cex = 0.5, 
     edge.arrow.size = 0.2, edge.arrow.width = 3)
dev.off()
```
![Graph of countries having to reduce consumption for a shock initiated at source countries (orange nodes). The width of each edge is proportional to $\log \Delta C / S_0$. Simulations initialized with 2009 input data and global parameters (see Table \ref{tab:var_list}) are set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01. \label{fig:dCext_net}](fig_dCext_net.png)

Contrasting with the overall trend towards a more globalized food trade network, our results show that the vulnerabilities to external shocks occur mostly at a regional scale, with American, South Asian / Indian Ocean and East Asian clusters clearly visible in Fig. \ref{fig:dCext_net} (the link from the United States to Japan being a notable exception).

\newpage


# Discussion and conclusion

In this study, we presented a dynamic simulation model that complements previous approaches aimed at understanding the effect of increasingly globalized trade networks on the resilience of national food supply systems. Initialized with historical food production and trade data, the model describes how a local production shock is propagated as countries use their reserves and trade links to buffer the loss in food supply. 

Based on data for a specific commodity group - cereals and cereal products - spanning a 17-year period from 1994 to 2011, we identified two global trends affecting the model's dynamics: an increase in both the number and volume of trade links (relative to production), but also a decrease and a more even distribution of global reserves (still relative to production). This latter point is particularly relevant to the ongoing discussion on the importance of food stocks [@fraser2015], as our results suggest that the distribution of reserves matters more than their aggregate quantity in terms of conferring resilience to shocks. Trade and reserves also interact: as more countries have the reserves to absorb production losses or the capacity to import more from countries with such reserves, both trends contribute to reducing the number and severity of cases where a local drop in production forces a decrease in domestic consumption. However, a greater reliance on imports increases the risk of critical food supply losses following a foreign shock, notably in the case of several Central American and Caribbean countries that import grains from the United States. 

Our analysis indicates that the countries most at risk of food shortages from external shocks tend to be concentrated in regional blocks. This risk would be compounded in cases where the production shock is not limited to a single country (as was modelled here) but instead jointly affects multiple countries in a region (as could be the case for environmental and weather-related events).

To avoid introducing too many adjustable parameters, we deliberately chose a minimal model of the agents' (in this case, national economies) behavior: all countries are willing to spend the same proportion of their reserves, and any shock transmitted to trade partners is partitioned equally among all trade links. The latter assumption is shared with other models of "contagion" in economic networks [e.g., @lee2011]. A few recent models of shock propagation in food commodity networks [@puma2015; @gephart2016] use a GDP-weighted partitioning, based on the assumption that countries with a higher purchasing power will have a greater ability to sustain their imports from production-stressed countries. A more realistic model could also take into account the obligations created by trade agreements. Since these more complex models would require careful parametrization, their implementation may be limited by our capacity to extract individual shocks from the available aggregate production/trade data. Further empirical research would help identify the appropriate statistics to discriminate between different simulation model versions. 

We can contrast our simulation-based approach with previous studies aimed at evaluating the global food trade network's resilience to supply shocks. Using an aggregated virtual water trade network, @sartori2015 analyzed the distribution of historical supply shocks as well as changes in the network structure over time, to support the thesis that the global food supply became more stable as the reliance of trade increased. However, the data alone does not suffice to isolate the effect of increased trade from that of other trends present in the historical record, such as a change in the distribution of food reserves. Our model not only differentiates the effect of these two trends, it also highlights the uneven impact of these changes among the most vulnerable countries, showing how relative risks may shift from one region to another.

By shedding light on the complex interactions that determine the link between trade and food security, our model also suggests different paths through which national economies can reduce the risk of food shortages, such as diversifying the sources of staple food supplies and ensuring that trading partners have the reserves to withstand a shock. We recognize however that these country-level metrics constitute only one dimension of food security, and that a more complete assessment requires consideration of within-country inequality in income, nutrition and access to food. Furthermore, while patterns of trade-dependency can be studied within the context of specific food commodity networks, their origin is intrinsically linked to larger socio-environmental problems, including differences in access to water or land, and the geographical distribution of pollution and other environmental externalities.


# Acknowledgments

We thank Roberto Patricio Korzeniewicz and Christina Prell for their participation in early discussions on this project. This work was supported by the National Socio-Environmental Synthesis Center (SESYNC) under funding received from the National Science Foundation grant DBI-1052875. M.J. Puma is supported by a fellowship from the Columbia University Center for Climate and Life and the Interdisciplinary Global Change Research under NASA cooperative agreement NNX08AJ75A, and D.A. Seekell was supported by the Carl Trygger Foundation for Scientific Research.


# References
