---
title: "Shifting risks in increasingly globalized food trade networks"
date: "12/12/2015"
output:
    pdf_document:
        fig_caption: yes
bibliography: ref.bib
---

```{r load_packages, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(igraph)
library(knitr)
library(stringr)
library(xtable)
library(cowplot)
```

```{r global_options, include=FALSE}
options(digits = 3, xtable.comment = FALSE)
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r load_funcs}
source("tfs_cascade_funcs.R")
source("tfs_map_funcs.R")
source("res_00_funcs.R")
```

# Methods

## Simulation model

Our model simulates the impact of a "shock" to the supply of some food commodity on the global trade network for that commodity. The shock is initiated as a drop in production in one or more countries and propagates through the network over multiple intertions of the simulation loop, which is summarized in Figure \ref{fig:sim_chart}. 

At each iteration, affected countries first tap into their reserves. When reserves are depleted, countries absorb a fraction of the residual shock by reducing domestic consumption, then reduce their trade balance by decreasing exports and increasing exports, with the impact spread to each trade link proportionally to the volume on that link. This effectively propagates the shock to those countries' trade partners. Finally, any shock that could not be propagated is absorbed by domestic consumption, and the cycle is repeated until all shocks have been absorbed (see the Appendix for a detailed description of the model). 

To avoid arbitrarily small shocks being propagated, countries will absorb (through consumption) any shock smaller than a fraction $\alpha$ of their current supply; we set $\alpha$ = 0.001% for all our simulations.

```{r variables_table}
kable(data.frame(rbind(
    c("$p$", "Production by country"),
    c("$r$", "Reserves by country"),
    c("$F$", "Trade matrix ($F_{jk}$ = exports from country $j$ to country $k$)"),
    c("$e$", "Exports by country i.e. $\\sum_k F_{jk}$"),
    c("$i$", "Imports by country i.e. $\\sum_k F_{kj}$"),
    c("$c$", "Domestic consumption by country (for any use)"),
    c("$s$", "Net supply, $s = p + i - e$"),
    c("$\\alpha$", "Minimum threshold (as fraction of $s$) for a shock to be propagated"),
    c("$f_c$", "Fraction of residual shock absorbed by $c$ if $r$ is depleted"),
    c("$f_r$", "Fraction of actual reserves that are available to absorb shocks"),
    c("$f_p$", "Magnitude of initial shock as a fraction of the affected country's $p$")
)), caption = "List of variables and parameters", col.names = c("Symbol", "Description"))
```

```{r flow_chart}
#system("dot -Tpng model-flow-chart.gv -o model-flow-chart.png")
system("dot -Tpdf model-flow-chart.gv -o model-flow-chart.pdf")
```

![Simulation model flow chart \label{fig:sim_chart}](model-flow-chart.pdf)

## Data

We use data from the Food and Agricultural Organization of the United Nations' online database (FAOSTAT, faostat3.fao.org) to construct the cereals production and trade data. The production and trade data for individual primary and secondary commodities in the cereals group is converted into kcal equivalents [@fao2001] and aggregated by country and year (*supplementary table to be added later*). We use population data from FAOSTAT to subset the network so that only countries with a population exceeding half a million people during the period 1986-2011. We rectify the data as described in @carr2013 to account for the merging and fracturing of countries between years.

We obtain data on countries' cereals reserves from the Production, Supply and Distribution database of the United States Department of Agriculture's Foreign Agricultural Service (USDA-PSD, apps.fas.usda.gov/psdonline/). Reserves for nine commodities (barley, corn, millet, mixed grain, oats, milled rice, rye, sorghum and wheat) were converted in kcal equivalents and aggregated by country and year, and political entities were rectified to match the FAO data above. Note that since USDA-PSD reports aggregated reserves for the European Union (pre-1998) and EU-25 (1998 and after), we divide these reserves between EU countries for each year in proportion to their share of the EU cereals production. 

For input to our model, we average the cereals production, reserves and trade over three five-year periods (1994-1998, 2001-2005 and 2007-2011), which we refer to by their median years (1996, 2003 and 2009). The evolution of the cereals trade across these three time periods shows a decrease of global reserves and an increase in global trade, both expressed as a fraction of total production.

```{r load_trade_data, results = "asis"}
years <- c(1996, 2003, 2009)
trade_dat <- lapply(years, get_trade_data, mov_avg = 2,
                    prod_trade_file = "data/cereals_prod_trade.RData", 
                    stocks_file = "data/cereals_stocks.RData")
names(trade_dat) <- years
trade_st <- bind_rows(lapply(trade_dat, get_trade_stats_sum), .id = "year")
kable(trade_st,
      col.names = c("year", "$\\sum p$ (kcal)", "$\\sum r$ (kcal)", 
                    "# trade links", "$\\sum F$ (kcal)",  
                    "$\\sum r / \\sum p$", "$\\sum F / \\sum p$"),
      caption = paste("Summary statistics of the cereals trade data",
                      "for each time period considered in our analysis"))
```

To separate the effects of changes in reserves and trade flows in our results, we perform two different scalings of the 1996 and 2003 reserves: in the $r$-scaled version, all countries' reserves are scaled by a common factor so that the ratio of total $r$ to total $p$ matches that of 2009; in the $r/s$-scaled version, the reserves are scaled by a country-specific factor so that the fraction of $r$ to net supply $s$ matches the 2009 data. Compared with the original data, simulation results from these scaled versions allow us to identify the impact of changes in total reserves or in the distribution of these reserves among countries, respectively.

```{r r_scaling}
Rscale <- trade_st$RP_ratio / trade_st$RP_ratio[trade_st$year == "2009"]
trade_Rscaled <- Map(
    function(dat, scal) {
        dat$R0 <- dat$R0 / scal
        dat
    }, trade_dat, Rscale)

S0 <- lapply(trade_dat, function(x) x$P0 + colSums(x$E0) - rowSums(x$E0))
RSscale <- trade_dat$`2009`$R0 / S0$`2009`
trade_RSscaled <- Map(
    function(dat, s0) {
        dat$R0 <- RSscale[names(s0)] * s0
        dat
    }, trade_dat, S0)
```

## Simulation parameters and response variables

For the purpose of this study, each model run performs one simulation starting from each country, using a specific year of data and a specific scaling of the reserves (see above). We also set three global parameters by model run: the initial shock magnitude as a fraction of the target country's production ($f_p$), the fraction of reserves that are available to absorb a shock ($f_r$), as well as the fraction of a shock absorbed by consumption after reserves are depleted ($f_c$, as defined in our model above). In practice, $f_r < 1$ may reflect the fact that some of the reported reserves are already committed to trade or that countries are unwilling to let reserves drop below some floor amount. 

```{r run_sims}
get_multiyear_sim_results <- function(trade_data, pfrac, rfrac, cfrac) {
    res <- lapply(trade_data, 
                  function(x) sim_allc(pfrac, x$P0, rfrac*x$R0, x$E0, cfrac))
    st <- lapply(res, get_stats_allc)
    trade_stats <- bind_rows(lapply(trade_data, get_trade_stats_by_cty),
                             .id = "year") 
    sim_stats <- bind_rows(lapply(st, get_sim_stats_by_cty))
    cbind(fp = pfrac, fr = rfrac, fc = cfrac, trade_stats, sim_stats)
}

#stats_by_cty <- bind_rows(
#    "02_05"    = get_multiyear_sim_results(trade_dat, 0.2, 0.5, 0.01),
#    "Rscaled"  = get_multiyear_sim_results(trade_Rscaled, 0.2, 0.5, 0.01),
#    "RSscaled" = get_multiyear_sim_results(trade_RSscaled, 0.2, 0.5, 0.01),
#    "01_025"   = get_multiyear_sim_results(trade_dat, 0.1, 0.25, 0.01),
#    "03_1"     = get_multiyear_sim_results(trade_dat, 0.3, 1, 0.01),
#    "015_05"   = get_multiyear_sim_results(trade_dat, 0.15, 0.5, 0.01),   
#    "02_05_005"= get_multiyear_sim_results(trade_dat, 0.2, 0.5, 0.05),
#    "02_05_01" = get_multiyear_sim_results(trade_dat, 0.2, 0.5, 0.1),    
#    .id = "params")

#stats_by_cty <- mutate(stats_by_cty, tot_dS_scl = tot_dS_S0 / fp, 
#                    tot_dC_scl = tot_dC_S0 / fp, self_dC_scl = self_dC_S0 / fp)

# Params groups
Rscal <- c("02_05", "Rscaled", "RSscaled")
Cfrac <- c("02_05", "02_05_005", "02_05_01")
PR <- c("01_025", "015_05", "02_05", "03_1")

#saveRDS(stats_by_cty, "stats_by_cty.RData")
stats_by_cty <- readRDS("stats_by_cty.RData")

```

For each model run, we report the number of simulations where the initial shock was transmitted ($n_s$), i.e. excluding those where the target country has no production or has available reserves that exceed the loss of production. We calculate the following summary metrics per country (pc): the number of *hits*, or simulations where the country receives a shock ($h_{(pc)}$); the number of hits where domestic consumption is affected ($h_{c (pc)}$); a scaled measure of the change in net supply ($\Delta s_{(pc)}$) and consumption ($\Delta c_{(pc)}$) over all simulations; and the evenness ($J$) of impact across simulations (see below).

To better compare the relative impacts across countries and model runs, $\Delta s_{(pc)}$ and $\Delta c_{(pc)}$ are scaled by the country's initial supply ($s_0$) and the relative magnitude of the initial shock $f_p$, i.e.
$$\Delta s_{(pc)} = \frac{\sum_k \Delta s_k}{f_p s_0} \; \text{and} \; 
  \Delta c_{(pc)} = \frac{\sum_k \Delta c_k}{f_p s_0} \, ,$$
where the sum is taken over simulations in the same run. These metrics are always negative and we focus on their magnitude in the text, e.g. a greater "shock" or "impact" referring to a more negative value.

Based on Pielou's measure of community evenness in ecology, $J$ is calculated as:
$$ J = - \frac{1}{\log n_c} \sum_k \pi_k \log \pi_k \, ,$$
where $n_c$ is the number of countries and $\pi_k$ is the proportion of the total $\Delta s$ affecting the focal country that is due to a shock starting at country $k$. The sum is over all $k$ where $\pi_k > 0$. When all the impact comes from a single simulation, $J = 0$; if it is due equally to shocks originating from all countries, $J = 1$. 


# Results

## Global parameters and network-wide effects

In Table \ref{tab:pars_stat}, we explore the effect of the model's global parameters on the simulation outputs for the most recent (2009) network. Between the first two rows, both $f_p$ and $f_r$ are doubled so that the ratio of shock intensity to initial reserves remains constant. This leaves most impact metrics unaffected, except for the mean $\Delta c_{(pc)}$, which nearly doubles. In this scenario, even if countries have larger available reserves, their trade flows remain the same and may limit the amount of residual shock that can be passed along, resulting in a greater impact on consumption. The same effect would explain the decrease in evenness $J$ between the two cases. Predictably, raising $f_c$ (third and fouth rows) monotonically increases the magnitude of $\Delta c_{(pc)}$ while leaving other statistics unchanged.

```{r tab_pars_stat, results = "asis"}
hits_summ <- stats_by_cty %>%
    filter(params %in% c(Cfrac, PR), year == 2009) %>%
    group_by(params) %>%
    summarise(fp = mean(fp), fr = mean(fr), fc = mean(fc),
              nshocks = sum(self_dC_scl < 0), 
              hits_m = mean(hits), hits_sd = sd(hits),
              mean_tot_dS = mean(tot_dS_scl), sd_tot_dS = sd(tot_dS_scl),
              mean_even = mean(even), sd_even = sd(even),
              hitsC = mean(hitsC), mean_tot_dC = mean(tot_dC_scl)) %>%
    select(-params) %>% arrange(desc(nshocks))

titlerow <- list(pos = list(0, 0),
    command = c(paste("$f_p$ & $f_r$ & $f_c$ & $n_s$ &",
                      "\\multicolumn{2}{c}{$h_{(pc)}$} &", 
                      "\\multicolumn{2}{c}{$\\Delta s_{(pc)}$} &",
                      "\\multicolumn{2}{c}{$J$} & $h_{c (pc)}$ &",
                      "$\\Delta c_{(pc)}$ \\\\\n"),
                paste("& & & & mean & s.d. & mean & s.d. &",
                      "mean & s.d. & & \\\\\n")))
pars_stat <- xtable(hits_summ, label = "tab:pars_stat",
    caption = "Effect of global parameters on output statistics (2009 data)",
    align = "lrrr|rrrrrrrrr")
print(pars_stat, add.to.row = titlerow, caption.placement = "top",
      include.rownames = FALSE, include.colnames = FALSE, 
      hline.after = c(-1, 0, 2, 4, 6))
```

Compared to the first two cases, the last two rows represent a 50% increase in shock intensity and a doubling of reserves. As more countries can absorb a shock through their reserves, the number of simulations where a shock is passed ($n_s$), as well as the mean number of hits ($h$ and $h_{c}$) by country all decrease. As a larger portion of the shock is absorbed by the initial target, $J$ also decreases.

Based on model runs with a fixed set of global parameters, the most recent trade network (2009) appears to have a greater capacity to absorb shocks compared with those of 1996 and 2003, as evidenced by smaller mean values of $h_{(pc)}$, $h_{c (pc)}$ and $\Delta c_{(pc)}$ (Table \ref{tab:Rscal_stat}). However, this pattern is largely driven by the distribution of reserves rather than increased trade. Despite the total reserves being greater in 1996 and 2003 -- which explains why the impact metrics are even higher when scaling these total reserves to 2009 levels -- they are less evenly distributed, with a few countries (such as China) holding a very large proportion of their net supply in reserve and more countries having no reserves at all. By scaling relative reserves by country to their 2009 values ($r/s$-scaling), we see that the number of hits by country monotonically increases over time, with a small increase in the mean evenness of the impact across simulations, all factors consistent with an increase of the number and volume of trade connections.

```{r tab_Rscal_stat, results = "asis"}
hits_summ_Rscal <- stats_by_cty %>%
    filter(params %in% c(Rscal), year != 2009 | params == "02_05") %>%
    group_by(params, year) %>%
    summarise(nshocks = sum(self_dC_scl < 0), 
              hits_m = mean(hits), hits_sd = sd(hits),
              mean_tot_dS = mean(tot_dS_scl), sd_tot_dS = sd(tot_dS_scl),
              mean_even = mean(even), sd_even = sd(even),
              hitsC = mean(hitsC), mean_tot_dC = mean(tot_dC_scl)) %>%
    ungroup %>% select(-params, -year)

rownames(hits_summ_Rscal) <- c("1996 (original)", "2003 (original)",
                               "2009 (original)", "1996 ($r$-scaled)",
                               "2003 ($r$-scaled)", "1996 ($r/s$-scaled)",
                               "2003 ($r/s$-scaled)")
titlerow <- list(pos = list(0, 0),
    command = c(paste("year (version) & $n_s$ &",
                      "\\multicolumn{2}{c}{$h_{(pc)}$} &", 
                      "\\multicolumn{2}{c}{$\\Delta s_{(pc)}$} &",
                      "\\multicolumn{2}{c}{$J$} & $h_{c (pc)}$ &",
                      "$\\Delta c_{(pc)}$ \\\\\n"),
                paste("& & mean & s.d. & mean & s.d. &",
                      "mean & s.d. & & \\\\\n")))
Rscal_stat <- xtable(hits_summ_Rscal, label = "tab:Rscal_stat",
    caption = paste("Summary statistics by input data version",
                    "($f_p$ = 0.2, $f_r$ = 0.5, $f_c$ = 0.01)"),
    align = "l|rrrrrrrrr")
print(Rscal_stat, add.to.row = titlerow, caption.placement = "top",
      include.colnames = FALSE, hline.after = c(-1, 0, 3, 5, 7),
      sanitize.rownames.function = function(x) {x})
```

While a more even distribution of reserves lessens the average impact on domestic consumption, it increases the average relative shock felt by countries ($\Delta s_{(pc)}$). To explain this pattern, we note that this average is directly related to the covariance between $\Delta s_{(pc)}$ and the initial supply $s_0$:

$$\mathrm{E} \left[ \sum_k \Delta s_k \right] 
    = \mathrm{E} \left[ \Delta s_{(pc)} \right] \mathrm{E} \left[f_p s_0 \right] 
    + \mathrm{cov} \left( \Delta s_{(pc)}, f_p s_0 \right) \; \text{and}$$

$$\mathrm{E} \left[ \Delta s_{(pc)} \right] 
    = \frac{\mathrm{E} \left[ \sum_k \Delta s_k \right]}{f_p \mathrm{E} \left[ s_0 \right]} 
    - \frac{1}{\mathrm{E} \left[ s_0 \right]} \mathrm{cov} \left( \Delta s_{(pc)}, s_0 \right) \, .$$
    
Since the mean supply equals the mean production, both the numerator and the denominator of the first term on the right-hand side are equal in magnitude to the mean initial shock over simulations, and thus:

$$\mathrm{E} \left[ \Delta s_{(pc)} \right] 
    = -1 - \frac{1}{\mathrm{E} \left[ s_0 \right]} \mathrm{cov} \left( \Delta s_{(pc)}, s_0 \right) \, .$$

The observation that $\mathrm{E} \left[ \Delta s_{(pc)} \right] > -1$ for all our model runs means that countries with a larger initial supply receive a proportionally greater impact from the shocks. This can be in turn related to the structure of the cereals trade network. A few large producers account for most of the net exports and receive more shocks due to their central position in the network. These main producers also tend to have proportionately higher reserves, allowing them to absorb most of these shocks. *[Note: Perhaps we need graphs in the supplementary materials showing this?]* Once again, a large portion of the change between 1996 and 2009 can be explained by the distribution of reserves, with the residual differences (shown in the $r/s$-scaled version) reflecting the intensification of trade.

Although the previous tables do not indicate the standard deviations for $h_{c (pc)}$ and $\Delta c_{(pc)}$, their distribution is highly skewed with most countries receiving little to no impact on their consumption. As such, we focus on the most impacted countries in the next section. 

## Country-level impacts

```{r ds_dc_prep}
# Load basemap
data(wrld_simpl)
world_df <- fortify(wrld_simpl)

plot_params <- c("02_05_1996", "RSscaled_1996", "02_05_2009")
ds_dc <- stats_by_cty %>% unite(version, params, year, sep = "_") %>%
    filter(version %in% plot_params) %>%
    select(id = cty, version, tot_dS_S0, tot_dC_S0)
ds_dc$version <- factor(ds_dc$version, levels = plot_params,
                        labels = c("1996 (original)", "1996 (r/s-scaled)", "2009"))
world_ds_dc <- inner_join(world_df, ds_dc)
```

```{r ds_map, fig.width = 7, fig.height = 10, fig.cap = "\\label{fig:ds_map}Total impact on net supply as a fraction of initial supply by country, for three versions of the input data. (Global simulation parameters set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01.)"}
ggplot() + geom_polygon(aes(long, lat, group = group, fill = tot_dS_S0),
                                 data = world_ds_dc, colour = "grey", size = 0.25) +
    scale_fill_gradient(low = "red", high = "white", na.value = "grey") +
    labs(title = expression(sum(Delta * s / s[0])), fill = "") +
    facet_wrap(~ version, ncol = 1) + coord_fixed() + theme_map()
```

```{r dc_map, fig.width = 7, fig.height = 10, fig.cap = "\\label{fig:dc_map}Total impact on domestic consumption as a fraction of initial supply by country, for three versions of the input data. Global simulation parameters set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01."}
ggplot() + geom_polygon(aes(long, lat, group = group, fill = tot_dC_S0),
                                 data = world_ds_dc, colour = "grey", size = 0.25) +
    scale_fill_gradient(low = "red", high = "white", na.value = "grey") +
    labs(title = expression(sum(Delta * c / s[0])), fill = "") +
    facet_wrap(~ version, ncol = 1) + coord_fixed() + theme_map()
```

Figure \ref{fig:ds_map} and \ref{fig:dc_map} present the total impact on the supply and consumption (respectively) of each country for three different model runs: original 1996 data, 1996 data scaled with $r/s$ ratios from 2009, and original 2009 data. As stated in the previous section, major exporters tend to absorb a disproportionate share of shocks (Fig. \ref{fig:ds_map}) due to their large reserves and high trade volumes. The larger impact on $\Delta s$ for Argentina and Australia in the last graph (2009) reflects the growing relative importance of their exports. Some countries with low production and high trade can also exhibit a high aggregate $\Delta s$, such as Oman, which increased both its reserves and trade volume between 1996 and 2009.

Countries where the simulated shocks produce significant decreases in domestic consumption are concentrated in a few regions: Central America, the Sahel and East Africa, South and South-East Asia and (in 1996 only) the former Soviet Union (Fig. \ref{fig:dc_map}). Compared with the original 1996 data, simulations using the $r/s$-scaled reserves led to smaller impacts to consumption overall. Changes in the trade network itself greatly reduced the $\Delta c$ impact on many countries, including most of the former Soviet Union, Afghanistan, Sudan and Tanzania, but led to larger impacts in others, notably in Central America. 

```{r dc_stats}
stats_dC <- stats_by_cty %>% 
    filter(params == "02_05" | params == "RSscaled" & year %in% c("1996", "2003"), 
           tot_dC_scl < 0) %>%
    select(-fp, -fr, -fc, -hits, -links_hit, -tot_dS_S0, -even, -tot_dS_scl) %>%
    mutate(ext_dC_scl = tot_dC_scl - self_dC_scl,
           ext_dC_S0 = tot_dC_S0 - self_dC_S0) %>%
    group_by(cty) %>%
    filter(min(tot_dC_S0) < -0.01)

stats_dC_min <- filter(stats_dC, tot_dC_S0 < -0.01)
stats_dC_ext <- filter(stats_dC, ext_dC_S0 < -0.01)

# 55 countries have no reserves at some point
#  28 have tot_dC_S0 < -0.01, 27 don't
no_res <- unique(stats_by_cty$cty[stats_by_cty$R0_S0 == 0])

# 67 countries in stats_dC_min:
# "AFG" "BGD" "BLR" "BTN" "BGR" "BFA" "BDI" "KHM" "CAF" "TCD" 
# "CRI" "PRK" "DOM" "SLV" "ETH" "GIN" "GNB" "HTI" "HND" "IND" 
# "IDN" "JAM" "KAZ" "KGZ" "LAO" "LTU" "MDG" "MWI" "MLI" "MEX" 
# "MMR" "NPL" "NER" "NGA" "PAN" "PNG" "POL" "ROU" "RUS" "SRB" 
# "SVK" "SLB" "SUR" "TLS" "TTO" "UGA" "UKR" "TZA" "VNM" "LSO" 
# "NIC" "PSE" "PAK" "RWA" "SOM" "TUR" "TKM" "UZB" "ARM" "COM" 
# "GTM" "JPN" "MNG" "SGP" "SWZ" "SDN" "ZWE"

# ext and self hits >1% (6): "BTN" "CAF" "AFG" "BGD" "NPL" "PRK"
# ext hits (21):  "CRI" "DOM" "SLV" "HTI" "HND" "JAM" "MEX" "PAN" "PNG" "SLB" "SUR" 
#                 "TTO" "NIC" "SOM" "ARM" "COM" "GTM" "JPN" "MNG" "SGP" "ZWE" 
```

```{r dc_prep}
#st_02_05 <- lapply(trade_dat, function(x) {
#  get_stats_allc(sim_allc(0.2, x$P0, 0.5*x$R0, x$E0, 0.01))  
#})

#st_RSscaled <- lapply(trade_RSscaled, function(x) {
#  get_stats_allc(sim_allc(0.2, x$P0, 0.5*x$R0, x$E0, 0.01))  
#})

get_dC_tall <- function(st, countries) {
    dC <- st$dC_S0[rownames(st$dC_S0) %in% countries, ]
    cbind(to = rownames(dC), as.data.frame(dC)) %>%
        gather(key = "from", value = "dC_S0", -to)
}

#dC_all <- bind_rows(
#    `02_05` = bind_rows(lapply(st_02_05, get_dC_tall,
#                                countries = unique(stats_dC$cty)), .id = "year"),
#    RSscaled = bind_rows(lapply(st_RSscaled, get_dC_tall, 
#                                countries = unique(stats_dC$cty)), .id = "year"),
#    .id = "params"
#)

#saveRDS(dC_all, "dC_all.RData")
dC_all <- readRDS("dC_all.RData")

dCext <- dC_all %>%
    filter(to %in% stats_dC_ext$cty, to != from, year != "2003") %>%
    group_by(to, from) %>% filter(any(dC_S0 < -1E-3))
dCself <- filter(dC_all, to == from, year != "2003") %>% 
    select(params, year, cty = to, dC_S0) %>%
    group_by(cty) %>% filter(any(dC_S0 < -1E-2))
rm(dC_all)
```

```{r dc_self, fig.cap = "\\label{fig:dc_self}Decrease in consumption (as a fraction of initial net supply) from a shock initiated at the target country. (Global simulation parameters set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01. Only showing countries with impact greater than 1% in at least one simulation.)"}
dCself_year <- spread(dCself, key = year, value = dC_S0)

ggplot(data = dCself_year, aes(x = `1996`, y = `2009`, 
                               group = cty, color = params)) +
    geom_text(aes(label = cty), alpha = 0.8, size = 3, angle = 45) +
    scale_color_brewer(type = "qual", palette = "Dark2", name = "",
                       labels = c("original", "r/s-scaled")) +
    geom_abline() + geom_line(color = "grey", linetype = "dotted")
```


```{r dc_ext, fig.cap = "\\label{fig:dc_ext}Decrease in consumption (as a fraction of initial net supply) from shocks initiated in other countries. (Global simulation parameters set at $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01. Only showing countries with impact greater than 1% in at least one simulation.)"}
dCext_year <- group_by(dCext, params, year, to) %>%
    summarise(dC_S0 = sum(dC_S0)) %>%
    spread(key = year, value = dC_S0)

ggplot(data = dCext_year, aes(x = `1996`, y = `2009`, 
                              group = to, color = params)) +
    geom_text(aes(label = to), alpha = 0.8, size = 3, angle = 45) +
    scale_color_brewer(type = "qual", palette = "Dark2", name = "",
                       labels = c("original", "r/s-scaled")) +
    geom_abline() + geom_line(color = "grey", linetype = "dotted")
```

We can gain additional insights on these results by differentiating the portion of $\Delta c$ in a country due to the shock initiated at that same country (internal shock) and those due to shocks initiated at other countries (external shocks). Figure \ref{fig:dc_self} compares the impact on the 40 countries that experience a >1% decrease in consumption due to an internal shock in at least one model run. Using either the original or $r/s$-scaled reserve levels, most countries lie above the dividing line and are thus less impacted in the 2009 trade network. This is consistent with the additional trade links and volume, which result in a greater capacity to transfer an internal shock to trade partners. 

Conversely, a majority of the 24 countries receiving a significant (>1% of $s_0$) external shock are more impacted under the 2009 trade network (Fig. \ref{fig:dc_ext}), reflecting an increased reliance on food imports from one or a few trade partners. A look at the specific external shocks causing these $\Delta c$ show that they originate from nine source countries (Fig. \ref{fig:dCext_net}), with 14 of them -- including the four greatest in magnitude -- being linked to a shock initiated in the United States. While the other target countries in the graph experience this risk from one or two simulations, the $\Delta c$ in Singapore is spread over five sources; it also has the lowest aggregate $\Delta c$, only slightly above the 1% threshold.

```{r dCext_net, fig.width = 6, fig.height = 6, fig.cap = "\\label{fig:dCext_net}Graph of countries (in blue) having to reduce consumption for a shock initiated at source countries (in orange). The width of each edge is proportional to $\\log \\Delta c / s_0$. Simulations initialized with 2009 input data and global parameters $f_p$ = 0.2, $f_r$ = 0.5 and $f_c$ = 0.01."}
dCext_graph <- graph_from_data_frame(
    filter(dCext, params == "02_05", year == "2009") %>%
    mutate(width = log(-dC_S0) + 7) %>%
    select(from, to, width)
)
V(dCext_graph)$color <- ifelse(degree(dCext_graph, mode = "out") == 0, 
                               "lightblue", "orange")

plot(dCext_graph, vertex.label.color = "black",
     vertex.size = 15, vertex.label.cex = 0.5, 
     edge.arrow.size = 0.2, edge.arrow.width = 3)
```


# Discussion

In this study, we presented a dynamic simulation model that complements previous approaches aimed at understanding the effect of increasingly globalized trade networks on the resilience of national food supply systems. Initialized with historical food production and trade data, the model describes how a local production shock is propagated as countries use their reserves and trade links to buffer the loss in food supply. 

Based on data for a specific commodity group - cereals and cereal products - spanning a 17-year period from 1994 to 2011, we identified two global trends affecting the model's dynamics: an increase in both the number and volume of trade links (relative to production), but also a decrease and a more even distribution of global reserves (still relative to production). As more countries have the reserves to absorb production losses or the capacity to export more from countries with such reserves, both trends contribute to reducing the number and severity of cases where a local drop in production forces a decrease in domestic consumption. However, a greater reliance on imports increases the risk of critical food supply losses following a foreign shock, notably in the case of several Central American and Caribbean countries that import grains from the United States. 

While previous studies [refs] have attempted to determine whether the global food trade network is becoming more or less resilient to supply shocks, our simulation results allow us to distinguish additional layers of complexity within this basic question. On one hand, they separate the effect of changes in the distribution of reserves to those of changes in the trade network itself. On the other hand, they highlight the uneven effect of these trends among the most vulnerable countries, showing how relative risks may shift from one region to another.

To avoid introducing too many adjustable parameters, we deliberately chose a minimal model of the agents' (in this case, national economies) behavior: all countries are willing to spend the same proportion of their reserves, and any shock transmitted to trade partners is partitioned equally among all trade links. The latter assumption is shared with other models of "contagion" in economic networks [refs], although a similar model by [Gephart et al. in press?] uses a GDP-weighted partitioning, based on the assumption that countries with a higher purchasing power will have a greater ability to sustain their imports from production-stressed countries. A more realistic model could also take into account the obligations created by trade agreements. 

[*...not sure how to continue/conclude, perhaps point out that more empirical research is needed to isolate the effect of a single shock from aggregate production/trade data, which would help test such models*]


# Appendix: Simulation model details

In our model, we define the annual net supply (or simply "supply") $s_j$ of a food commodity in country $j$ as:
$$s_j = p_j + i_j - e_j \, ,$$ 
where $p$ is production, $i$ is imports and $e$ is exports. The difference between this supply and domestic consumption $c$ must result in a change in the country's reserves $r$, so that: 
$$s_j = c_j + \Delta r_j \, .$$ 
Note that this convention differs from the FAO's definition of domestic supply, which includes a term representing transfer *from* the reserves, whereas a positive $\Delta r$ in our case represents a transfer *to* the reserves. 

We initialize the model with realistic production, trade and reserves data and assume that the initial consumption equals supply, i.e. $\Delta r = 0$ before any shock. The trade data is represented by a matrix $F$ where $F_{jk}$ is the volume of exports from country $j$ to country $k$. 

In the first iteration of the model ($t$ = 1), a supply shock is initiated from a drop in production:
$$ \Delta s'_{1,j} = \Delta p_{j} \, ,$$
where $\Delta p_{j} = 0$ for all but one or a few countries. In the following iterations, $\Delta s'$ is caused by a decrease in imports or an increase in exports as the shock is propagated through trade. The prime ($'$) notation is used to distinguish different temporary values of the shock within a single iteration. 

At the start of an iteration, all countries receiving a new shock (from any source) first attempt to absorb it through their reserves:
$$ \Delta r_{t,j} = \max \left( \Delta s'_{t,j}, -r_{t,j} \right) \, . $$ 

Any country that has depleted its reserves (or had none to begin with) will block any increase in its outgoing trade and is thus removed from the set $\mathcal{U}$, which initially includes all countries.
$$ \mathcal{U} = \mathcal{U} \setminus 
    \left\{ j \mid \Delta s'_{t,j} < -r_{t,j} \right\} \, . $$
    
At this point, countries left with a residual shock absorb a fraction of it ($f_c$) by reducing domestic consumption, leaving an amount $\Delta s''_{t,j}$ that can be transferred to other countries through trade:                 
$$ \Delta s''_{t,j} = \left( \Delta s'_{t,j} - \Delta r_{t,j} \right)
                      \left( 1 - f_c \right) \, . $$ 
To avoid spending a large fraction of the simulation time passing tiny residual shocks, we define a fractional threshold $\alpha$ so that countries simply absorb their residual shock when $\lvert \Delta s''_{t,j} \rvert < \alpha \, s_{t,j}$. 

A country can transfer a shock to its trade partners by either reducing its exports or increasing its imports, i.e. by decreasing its balance of trade $b$. We set an upper bound on the magnitude of this change to be equal to the total volume $v$ on all the country's trade links, excluding any "blocked" incoming links:
$$ v_{t,j} = \sum_k F_{t,jk} + \sum_k F_{t,kj} \, \mathbf{1}_{\mathcal{U}}(k)$$ and
$$ \Delta b_{t,j} = \max \left( \Delta s''_{t,j}, -v_{t,j} \right) \, ,$$ 
where $\mathbf{1}_{\mathcal{U}}(k)$ equals 1 if $k$ is in $\mathcal{U}$ and 0 otherwise.  

Each country then changes the trade volume on each unblocked link (- if outgoing, + if incoming) proportionally to the current volume on that link. From this, we can calculate the change of any element of the trade matrix as:
$$ \Delta F_{t,jk} = \left[ \left( \frac{\Delta b_{t,j}}{ v_{t,j}} \right)  
                          - \mathbf{1}_{\mathcal{U}}(j) 
                            \left( \frac{\Delta b_{t,k}}{ v_{t,k}} \right)
                            \right] F_{t,jk} \, .$$

Finally, any portion of the initial shock not absorbed by reserves or passed through trade results in a decrease in consumption:
$$ \Delta c_{t,j} = \Delta s'_{t,j} - \Delta r_{t,j} - \Delta b_{t,j} \, .$$

To start the next iteration, we update the vectors $r$, $c$ and $s$ as well as the trade matrix $F$ based on the computed $\Delta$. Note that the actual change in $s$ for a given country only depends on the fraction of the shock that was absorbed internally:
$$ \Delta s_{t,j} = \Delta r_{t,j} + \Delta c_{t,j} \, .$$
The new shock received by each country at the next iteration equals the sum of all increases in exports or decreases in imports due to other countries' actions at this iteration, i.e.:
$$ \Delta s'_{t+1,j} = \sum_k \Delta F_{t,kj} - \sum_k \Delta F_{t,jk} 
                      + \Delta b_{t,j} \, ,$$
where the last term serves to remove the effect of the country's own actions. When $\Delta s'_{t+1, j} = 0$ for all $j$, all shocks have been absorbed internally and the simulation ends.

# References
